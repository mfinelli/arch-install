---
- name: Installing bootstrap packages
  ansible.builtin.apt:
    name:
      - ansible
      - git
    state: present

- name: Uninstalling apt-transport-https
  ansible.builtin.apt:
    name: apt-transport-https
    state: absent

- name: Copying https-enabled sources list
  ansible.builtin.template:
    dest: /etc/apt/sources.list
    group: root
    mode: "0644"
    owner: root
    src: sources.list.j2

- name: Copying https-enabled raspi sources list
  ansible.builtin.template:
    dest: /etc/apt/sources.list.d/raspi.list
    group: root
    mode: "0644"
    owner: root
    src: raspi.list.j2

- name: Copying locale.gen
  ansible.builtin.copy:
    dest: /etc/locale.gen
    group: root
    mode: "0644"
    owner: root
    src: locale.gen
  notify:
    - Regenerate locales

- name: Creating systemd-resolved configuration directory
  ansible.builtin.file:
    group: root
    mode: "0755"
    owner: root
    path: /etc/systemd/resolved.conf.d
    state: directory

- name: Copying custom systemd-resolved configuration
  ansible.builtin.copy:
    dest: /etc/systemd/resolved.conf.d/dns.conf
    group: root
    mode: "0644"
    owner: root
    src: resolved.conf
  notify:
    - Restart systemd-resolved

- name: Enabling systemd-resolved
  ansible.builtin.systemd:
    enabled: true
    name: systemd-resolved.service
    state: started

- name: Linking systemd-resolved stub resolver
  ansible.builtin.file:
    dest: /etc/resolv.conf
    force: true
    src: /run/systemd/resolve/stub-resolv.conf
    state: link

# TODO: we should update_cache based on the above two templates
- name: Installing openssh
  ansible.builtin.apt:
    name: openssh-server
    update_cache: true

- name: Enabling sshd service
  ansible.builtin.systemd:
    enabled: true
    name: ssh.service
    state: started

- name: Copying sshd configuration
  ansible.builtin.copy:
    dest: /etc/ssh/sshd_config
    group: root
    mode: "0644"
    owner: root
    src: sshd_config
    validate: /usr/sbin/sshd -tf %s
  notify:
    - Restart sshd

- name: Installing main applications
  ansible.builtin.apt:
    name:
      - htop
      - libarchive-tools
      - lm-sensors
      - neofetch
      - pcscd
      - ripgrep
      - scdaemon
      - screen
      - sysstat
      - universal-ctags
      - vim
    state: present

- name: Installing backup applications
  ansible.builtin.apt:
    name:
      - borgbackup
      - rclone
    state: present

- name: Configuring FDE and boot
  ansible.builtin.include_tasks: boot.yml

- name: Configuring basic firewall
  ansible.builtin.include_tasks: firewall.yml
