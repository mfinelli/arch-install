---
- name: Ensure setup dependencies
  ansible.builtin.apt:
    name:
      - ansible
      - git

- name: Install apt-transport-https
  ansible.builtin.apt:
    name: apt-transport-https

- name: Install https sources list
  ansible.builtin.template:
    src: sources.list.j2
    owner: root
    group: root
    mode: "0644"
    dest: /etc/apt/sources.list

- name: Install https raspi sources list
  ansible.builtin.template:
    src: raspi.list.j2
    owner: root
    group: root
    mode: "0644"
    dest: /etc/apt/sources.list.d/raspi.list

  # TODO: we should update_cache based on the above two templates
- name: Install firefox
  ansible.builtin.apt:
    name: firefox-esr
    update_cache: true

- name: Ensure openssh is installed
  ansible.builtin.apt:
    name: openssh-server

- name: Ensure sshd is running and enabled
  ansible.builtin.systemd:
    name: ssh.service
    enabled: true
    state: started

- name: Copy sshd config
  ansible.builtin.copy:
    src: sshd_config
    owner: root
    group: root
    mode: "0644"
    dest: /etc/ssh/sshd_config
    validate: /usr/sbin/sshd -tf %s
  notify:
    - Restart sshd

- name: Install other applications
  ansible.builtin.apt:
    name:
      - htop
      - libarchive-tools
      - lm-sensors
      - neofetch
      - pcscd
      - ripgrep
      - scdaemon
      - screen
      - sysstat
      - universal-ctags
      - vim

- name: Install backup applications
  ansible.builtin.apt:
    name:
      - borgbackup
      - rclone

- name: Configure FDE and boot
  ansible.builtin.include_tasks: boot.yml
