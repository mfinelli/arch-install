---
- name: Install unbound
  ansible.builtin.apt:
    name: unbound

- name: Install new resolvconf.conf
  ansible.builtin.copy:
    dest: /etc/resolvconf.conf
    owner: root
    group: root
    mode: "0644"
    src: resolvconf.conf
  notify:
    - Update resolv.conf

- name: Ensure resolvconf forward zone is absent
  ansible.builtin.file:
    path: /etc/unbound/unbound.conf.d/resolvconf_resolvers.conf
    state: absent
  notify:
    - Restart unbound

- name: Install main unbound configuration
  ansible.builtin.copy:
    dest: /etc/unbound/unbound.conf.d/unbound.conf
    owner: root
    group: root
    mode: "0644"
    src: unbound.conf
  notify:
    - Restart unbound

- name: Setup cloudflare as upstream resolver
  ansible.builtin.copy:
    dest: /etc/unbound/unbound.conf.d/cloudflare.conf
    owner: root
    group: root
    mode: "0644"
    src: cloudflare.conf
  notify:
    - Restart unbound

- name: Ensure unbound is started and enabled
  ansible.builtin.systemd:
    name: unbound.service
    enabled: true
    state: started
