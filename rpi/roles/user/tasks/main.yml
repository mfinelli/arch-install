---
- name: Creating "mario" user
  ansible.builtin.user:
    groups:
      - adm
      - audio
      - cdrom
      - dialout
      - games
      - gpio
      - i2c
      - input
      - lpadmin
      - netdev
      - plugdev
      - render
      - spi
      - sudo
      - users
      - video
    name: mario

- name: Copying sudo rule for mario
  ansible.builtin.copy:
    dest: /etc/sudoers.d/010_mario-nopasswd
    group: root
    mode: "0440"
    owner: root
    src: mario
    validate: "visudo -cf %s"

- name: Adding SSH authorized keys for mario
  ansible.posix.authorized_key:
    exclusive: true
    # yamllint disable rule:line-length
    key: |
      ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC4MZX4N4c73onEGKP3x8DEo7mhd8ahqQEhydgM2hTHo mario
      ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGLzoWaCMxwWMyepLYUu6FBbYZmDOaXPj+LQtWjdM8pW mario@ipad
      ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOy1DGNkaHw4UiGX8H7L4ruWjWBYFSkOEvB1jqAt5rdz mario@iphone
    # yamllint enable rule:line-length
    user: mario

- name: Creating "src" directory
  become: true
  become_user: mario
  ansible.builtin.file:
    group: mario
    mode: "0755"
    owner: mario
    path: /home/mario/{{ item }}
    state: directory
  loop:
    - src
    - src/mfinelli

- name: Cloning this repository for easier updates
  become: true
  become_user: mario
  ansible.builtin.git:
    dest: /home/mario/src/mfinelli/arch-install
    repo: https://github.com/mfinelli/arch-install.git

- name: Removing the default "pi" user
  when: whoami != 'pi'
  ansible.builtin.user:
    name: pi
    remove: true
    state: absent

- name: Removing the default pi user sudo rule
  when: whoami != 'pi'
  ansible.builtin.file:
    path: /etc/sudoers.d/010_pi-nopasswd
    state: absent
