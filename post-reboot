#!/bin/bash

source helpers.sh

WORKDIR=$(mktemp -d)

for package in package-query yaourt; do
    cd $WORKDIR
    wget https://aur.archlinux.org/cgit/aur.git/snapshot/$package.tar.gz
    tar -zxvf $package.tar.gz
    cd $package && makepkg
    sudo pacman -U $(ls *.tar.xz)
done

cd
rm -rf $WORKDIR

yaourt -S reflector abs pkgcacheclean namcap pkgbuild-introspection downgrade

# only download from https mirrors
sudo reflector --verbose -l 25 -p https --sort rate \
    --save /etc/pacman.d/mirrorlist

PACMAN_TMP=$(mktemp)

# add ILoveCandy configuration option to end of first block of [option]s
# adapted from: http://stackoverflow.com/a/16102492
awk '
  $0 == "[options]" { inOptions = 1 }
  inOptions && $0 == "" {
    print "ILoveCandy"
    inOptions = 0
  }
  1' /etc/pacman.conf > $PACMAN_TMP

sudo mv $PACMAN_TMP /etc/pacman.conf
sudo chown root:root /etc/pacman.conf
sudo chmod 644 /etc/pacman.conf

MAKEPKG_TMP=$(mktemp)
read -p "How many cores to use when compiling packages from source? "
CORES=$((REPLY + 1))
sed "/MAKEFLAGS=\"/s/-j[0-9]/-j$CORES/" /etc/makepkg.conf > $MAKEPKG_TMP
sudo mv $MAKEPKG_TMP /etc/makepkg.conf
sudo chown root:root /etc/makepkg.conf
sudo chmod 644 /etc/makepkg.conf

yaourt -S xfce4-dockbarx-plugin volumeicon xterm kalu
yaourt -S xcursor-openzone
yaourt -S ttf-{dejavu,mathtype,driod,liberation,freefont,symbola} \
    ttf-{linux-libertine,google-fonts,carlito,caladea} \
    otf-{zxx,fira-sans,fira-mono}

yaourt -S xfce-theme-{manager,greybird,bluebird,albatross,blackbird} \
    shimmer-wallpapers elementary-{xfce-icons,icon-theme} awoken-icons

if [[ "yes" == $(prompt_yesno "Install bluetooth packages?") ]]; then
    yaourt -S bluez{,-utils} blueman
    sudo systemctl enable bluetooth
    gsettings set org.blueman.transfer shared-path /home/`whoami`/Downloads
fi

yaourt -S keepass xsel spideroak-one dropbox

yaourt -S libreoffice-fresh{,-it,-fr} hunspell-{en,it,fr} hyphen-{en,it,fr} \
    mythes{,-en,-it,-fr}

if [[ "yes" == $(prompt_yesno "Install the GIMP?") ]]; then
    GIMP_INSTALL=true
    yaourt -S gimp{,-extras} \
        gimp-plugin-{resynthesizer-git,saveforweb,exif-browser,fourier} \
        gimp-script-{descreen,smart-remove}
else
    GIMP_INSTALL=false
fi

if [[ "yes" == $(prompt_yesno "Install scanning software?") ]]; then
    if [[ $GIMP_INSTALL == true ]]; then
        yaourt -S sane xsane xsane-gimp
    else
        yaourt -S sane xsane
    fi
fi

yaourt -S shotwell dia dcraw

yaourt -S pidgin purple-plugin-pack aspell-{en,it,fr} pidgin-otr hexchat

if [[ "yes" == $(prompt_yesno "Install thunderbird?") ]]; then
    yaourt -S thunderbird thunderbird-i18n-{it,fr}

    if [[ "yes" == $(prompt_yesno "Install enigmail for thunderbird?") ]]
    then
        gpg --keyserver pgp.mit.edu --recv-keys 9369CDF3 DD5F693B
        yaourt -S thunderbird-enigmail
    fi
fi

yaourt -S mutt isync msmtp lynx vim-spell-{en,it,fr}

if [[ "yes" == $(prompt_yesno "Install tor browser bundle?") ]]; then
    gpg --keyserver pgp.mit.edu --recv-keys D40814E0
    yaourt -S tor-browser-en
fi
