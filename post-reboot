#!/bin/bash

source helpers.sh

WORKDIR=$(mktemp -d)

for package in package-query yaourt; do
    cd $WORKDIR
    wget https://aur.archlinux.org/cgit/aur.git/snapshot/$package.tar.gz
    tar -zxvf $package.tar.gz
    cd $package && makepkg
    sudo pacman -U $(ls *.tar.xz)
done

cd
rm -rf $WORKDIR

yaourt -S reflector abs pkgcacheclean namcap pkgbuild-introspection downgrade

# only download from https mirrors
sudo reflector --verbose -l 25 -p https --sort rate \
    --save /etc/pacman.d/mirrorlist

PACMAN_TMP=$(mktemp)

# add ILoveCandy configuration option to end of first block of [option]s
# adapted from: http://stackoverflow.com/a/16102492
awk '
  $0 == "[options]" { inOptions = 1 }
  inOptions && $0 == "" {
    print "ILoveCandy"
    inOptions = 0
  }
  1' /etc/pacman.conf > $PACMAN_TMP

sudo mv $PACMAN_TMP /etc/pacman.conf
sudo chown root:root /etc/pacman.conf
sudo chmod 644 /etc/pacman.conf

MAKEPKG_TMP=$(mktemp)
read -p "How many cores to use when compiling packages from source? "
CORES=$((REPLY + 1))
sed "/MAKEFLAGS=\"/s/-j[0-9]/-j$CORES/;/MAKEFLAGS=\"/s/^#//" \
    /etc/makepkg.conf > $MAKEPKG_TMP
sudo mv $MAKEPKG_TMP /etc/makepkg.conf
sudo chown root:root /etc/makepkg.conf
sudo chmod 644 /etc/makepkg.conf

yaourt -S xfce4-dockbarx-plugin volumeicon xterm kalu
yaourt -S xcursor-openzone
yaourt -S ttf-{mathtype,liberation,freefont,symbola} \
    ttf-{linux-libertine,google-fonts-git,carlito,caladea} \
    otf-{zxx,fira-sans,fira-mono}

yaourt -S xfce-theme-{manager,greybird,bluebird,albatross,blackbird} \
    shimmer-wallpapers elementary-{xfce-icons,icon-theme} awoken-icons

if [[ "yes" == $(prompt_yesno "Install bluetooth packages?") ]]; then
    yaourt -S bluez{,-utils} blueman
    sudo systemctl enable bluetooth
    gsettings set org.blueman.transfer shared-path /home/`whoami`/Downloads
fi

yaourt -S keepass xsel spideroak-one dropbox

yaourt -S libreoffice-fresh{,-it,-fr} hunspell-{en,it,fr} hyphen-{en,it,fr} \
    mythes{,-en,-it,-fr}

if [[ "yes" == $(prompt_yesno "Install the GIMP?") ]]; then
    GIMP_INSTALL=true
    yaourt -S gimp{,-extras} \
        gimp-plugin-{resynthesizer-git,saveforweb,exif-browser} \
        gimp-script-{descreen,smart-remove} gimp-fourier
else
    GIMP_INSTALL=false
fi

if [[ "yes" == $(prompt_yesno "Install scanning software?") ]]; then
    if [[ $GIMP_INSTALL == true ]]; then
        yaourt -S sane xsane xsane-gimp
    else
        yaourt -S sane xsane
    fi
fi

yaourt -S shotwell dia dcraw

yaourt -S pidgin purple-plugin-pack aspell-{en,it,fr} pidgin-otr hexchat

if [[ "yes" == $(prompt_yesno "Install thunderbird?") ]]; then
    yaourt -S thunderbird thunderbird-i18n-{it,fr}

    if [[ "yes" == $(prompt_yesno "Install enigmail for thunderbird?") ]]
    then
        gpg --keyserver pgp.mit.edu --recv-keys 9369CDF3 DD5F693B
        yaourt -S thunderbird-enigmail
    fi
fi

yaourt -S mutt isync msmtp lynx vim-spell-{en,it,fr}

if [[ "yes" == $(prompt_yesno "Install tor browser bundle?") ]]; then
    gpg --keyserver pgp.mit.edu --recv-keys D40814E0
    yaourt -S tor-browser-en
fi

yaourt -S file-roller snapper archey-git grub-customizer dnsutils colordiff \
    cfv tmux p7zip
yaourt -S --asdeps unrar cdrkit

yaourt -S imagemagick ghostscript

yaourt -S chromium
yaourt -S deluge vlc youtube-dl
yaourt -S --asdeps libdvdcss libaacs

if [[ "yes" == $(prompt_yesno "Install google chrome?") ]]; then
    yaourt -S google-chrome
fi

yaourt -S texlive-most texlive-lang

for package in sublime-text-dev gummi phpstorm rubymine; do
    if [[ "yes" == $(prompt_yesno "Install $package?") ]]; then
        yaourt -S $package
    fi
done

echo "Wine on 64bit systems requires the multilib repository."
if [[ "yes" == $(prompt_yesno "Install wine packages?") ]]; then
    yaourt -S wine wine-mono wine_gecko winetricks
    yaourt -S --asdeps perl-lwp-protocol-https

    if [[ "yes" == $(prompt_yesno "Install music manipulation programs?") ]]
    then
        yaourt -S foobar2000 mp3tag musicbrainz picard
    fi
fi

for package in liferea vinagre handbrake cksfv calibre thefuck; do
    if [[ "yes" == $(prompt_yesno "Install $package?") ]]; then
        yaourt -S $package
    fi
done

yaourt -S redshift

if [[ "yes" == $(prompt_yesno "Install printing packages?") ]]; then
    yaourt -S cups cups-pdf gutenprint foomatic-db{,-engine,-nonfree} \
        hplip splix

    if [[ "yes" == $(prompt_yesno "Install packages for network printing?") ]]
    then
        yaourt -S avahi samba
        sudo systemctl enable avahi-daemon.service
    fi

    sudo systemctl enable org.cups.cupsd.service
fi

yaourt -S gnucash
yaourt -S --asdeps perl-{finance-quote,date-manip}

if [[ "yes" == $(prompt_yesno "Install zsh?") ]]; then
    yaourt -S zsh grml-zsh-config zsh-syntax-highlighting
fi

yaourt -S bash-completion

if [[ "yes" == $(prompt_yesno "Install spotify?") ]]; then
    yaourt -S spotify
fi

yaourt -S kdegraphics-okular

if [[ "yes" == $(prompt_yesno "Install MariaDB?") ]]; then
    yaourt -S mariadb
    sudo mysql_install_db --user=mysql --basedir=/usr --datadir=/var/lib/mysql

    MARIADB_TMP=$(mktemp)
    awk '
      $0 == "[mysqld]" { inMysqld = 1 }
      inMysqld && $0 == "" {
        print "collation-server = utf8mb4_unicode_ci"
        print "character-set-server = utf8mb4"
        inMysqld = 0
      }
      1' /etc/mysql/my.cnf > $MARIADB_TMP
    sudo mv $MARIADB_TMP /etc/mysql/my.cnf
    sudo chown root:root /etc/mysql/my.cnf
    sudo chmod 644 /etc/mysql/my.cnf
fi

if [[ "yes" == $(prompt_yesno "Install PHP?") ]]; then
    yaourt -S php php-{gd,apcu,composer,geoip,intl,tidy}

    for extension in curl exif gd iconv intl mysqli pdo_mysql tidy zip; do
        PHP_TMP=$(mktemp)
        sed "/extension=$extension.so/s/^;//" /etc/php/php.ini > $PHP_TMP

        sudo mv $PHP_TMP /etc/php/php.ini
        sudo chown root:root /etc/php/php.ini
        sudo chmod 644 /etc/php/php.ini
    done

    PHP_TMP=$(mktemp)
    sed "/zend_extension=opcache.so/s/^;//" /etc/php/php.ini > $PHP_TMP

    sudo mv $PHP_TMP /etc/php/php.ini
    sudo chown root:root /etc/php/php.ini
    sudo chmod 644 /etc/php/php.ini

    PHP_TMP=$(mktemp)
    awk '{print} $0 == ";date.timezone =" { print "date.timezone = UTC" }' \
        /etc/php/php.ini > $PHP_TMP

    sudo mv $PHP_TMP /etc/php/php.ini
    sudo chown root:root /etc/php/php.ini
    sudo chmod 644 /etc/php/php.ini

    yaourt -S php-imagick
    yaourt -S php-codesniffer{,-symfony2-git} php-cs-fixer phpunit php-box

    if [[ "yes" == $(prompt_yesno "Install drupal packages?") ]]; then
        yaourt -S php-codesniffer-drupal drush
    fi
fi

if [[ "yes" == $(prompt_yesno "Install redis?") ]]; then
    yaourt -S redis
fi

if [[ "yes" == $(prompt_yesno "Install nodejs packages?") ]]; then
    yaourt -S nodejs npm bower gulp uglify-js pm2
    yaourt -S nodejs-{uglifycss,autoprefixer,sequelize-cli,mocha,eslint}
fi

if [[ "yes" == $(prompt_yesno "Install ruby packages?") ]]; then
    yaourt -S ruby{,-bundler}

    if [[ "yes" == $(prompt_yesno "Install ruby css tools?") ]]; then
        yaourt -S ruby-{compass,sass,scss_lint}
    fi
fi

yaourt -S jpegoptim
yaourt -S postfix
yaourt -S beanstalkd

yaourt -S s3cmd aws-cli
yaourt -S --asdeps python{,2}-magic

if [[ "yes" == $(prompt_yesno "Install ansible?") ]]; then
    yaourt -S ansible ansible-lint
    yaourt -S --asdeps python2-passlib
fi

if [[ "yes" == $(prompt_yesno "Install puppet tools?") ]]; then
    yaourt -S vim-puppet puppet-lint
fi

if [[ "yes" == $(prompt_yesno "Install pebble SDK?") ]]; then
    yaourt -S pebble-sdk
fi

yaourt -S backblaze-b2-git
