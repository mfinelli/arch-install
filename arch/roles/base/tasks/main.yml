---
- name: use systemd for ntp
  become: true
  ansible.builtin.command: timedatectl set-ntp true
  register: timedatectl_setntp
  changed_when: timedatectl_setntp.rc == 0
  failed_when: timedatectl_setntp.rc != 0

- name: set timezone
  become: true
  community.general.timezone: name={{ timezone }}

- name: ensure baseline archlinux system
  become: true
  community.general.pacman:
    name:
      - base
      - base-devel
      - linux
      - linux-firmware
      - sof-firmware
      - posix

- name: install locale.gen
  become: true
  ansible.builtin.copy:
    dest: /etc/locale.gen
    owner: root
    group: root
    mode: 0644
    src: locale.gen
  register: locales_list

- name: locale-gen
  when: locales_list.changed # noqa no-handler
  become: true
  ansible.builtin.command: locale-gen

- name: install locale.conf
  become: true
  ansible.builtin.template:
    dest: /etc/locale.conf
    owner: root
    group: root
    mode: 0644
    src: locale.conf.j2

- name: install bootstrap packages
  become: true
  when: mtype != 'server'
  community.general.pacman:
    name:
      - grub
      - efibootmgr
      - btrfs-progs
      - dosfstools
      - ntfs-3g
      - e2fsprogs
      - exfat-utils
      - f2fs-tools
      - os-prober
      - lvm2
      - cryptsetup
      - mdadm
      - usbutils

- name: install video and input drivers
  become: true
  when: mtype != 'server'
  community.general.pacman:
    name:
      - mesa
      - xf86-input-libinput

- name: install intel microcode
  become: true
  when:
    - mtype != 'server'
    - "'GenuineIntel' in ansible_processor"
  community.general.pacman: name=intel-ucode

- name: install amd microcode
  become: true
  when:
    - mtype != 'server'
    - "'AuthenticAMD' in ansible_processor"
  community.general.pacman: name=amd-ucode

- name: install mkinitcpio configuration
  become: true
  when: mtype != 'server'
  ansible.builtin.copy:
    dest: /etc/mkinitcpio.conf
    owner: root
    group: root
    mode: 0644
    src: mkinitcpio.conf
  register: mkinitcpio_config

- name: mkinitcpio
  when: mkinitcpio_config.changed # noqa no-handler
  become: true
  ansible.builtin.command: mkinitcpio -p linux

- name: ensure sudoer rule
  become: true
  ansible.builtin.copy:
    dest: /etc/sudoers.d/gsudo
    owner: root
    group: root
    mode: 0440
    src: sudoer
    validate: 'visudo -cf %s'

- include: pacman.yml

- name: install ansible-gpg-key (from supermario repo)
  become: true
  community.general.pacman: name=ansible-gpg-key-git

- name: install pikaur
  kewlfft.aur.aur: name=pikaur

- name: install networking tools
  become: true
  when: mtype != 'server'
  community.general.pacman:
    name:
      - iw
      - iwd
      - dialog
      - wpa_supplicant
      - easy-rsa
      - networkmanager
      - networkmanager-openvpn
      - wireless-regdb
      - netctl

- name: install inetutils for `hostname`
  become: true
  community.general.pacman: name=inetutils

- name: install wireless regdom
  become: true
  when: mtype != 'server'
  ansible.builtin.template:
    dest: /etc/conf.d/wireless-regdom
    owner: root
    group: root
    mode: 0644
    src: wireless-regdom.j2

- name: install old base group packages
  become: true
  community.general.pacman:
    name:
      - logrotate
      - man-db
      - nano
      - perl
      - s-nail
      - texinfo
      - vi
      - man-pages
      - bash-completion

- name: install ansible and dependencies
  become: true
  community.general.pacman:
    name:
      - ansible
      - git
      - pyalpm

- name: install everywhere packages
  become: true
  community.general.pacman:
    name:
      - vim
      - vim-spell-en
      - vim-spell-es
      - vim-spell-fr
      - vim-spell-it
      - lynx
      - rsync
      - wget

- name: uninstall old packages
  become: true
  community.general.pacman:
    name:
      - python-py-cpuinfo
      - xf86-video-vesa
      - xf86-video-intel
      - xf86-video-ati
      - xf86-video-amdgpu
      - ansible-aur
    state: absent

- include: finellictl.yml
